{"version":3,"sources":["../../../app/service/io.js"],"names":["module","exports","SOCKET","MESSAGE","CHAT","app","model","User","Question","Circle","Message","Chat","IOService","token","userId","getUserId","socketId","ctx","socket","id","redis","set","userToken","targetId","content","type","chatId","sender","save","get","targetSocketId","nsp","sockets","emit","sadd","circleId","findById","user","myId","nickName","circle","authorId","authorSocketId","questionId","question","attentions","_id","title","rpush","forEach","expertId","expertSocketId","jwt","verify","Service"],"mappings":"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","file":"io.js","sourcesContent":["'use strict';\n\nmodule.exports = app => {\n  const SOCKET = 'SOCKET';\n  const MESSAGE = 'MESSAGE';\n  const CHAT = 'CHAT';\n  const {\n    User,\n    Question,\n    Circle,\n    Message,\n    Chat,\n  } = app.model;\n\n  class IOService extends app.Service {\n\n    /**\n     * 登录\n     * @param {String} token token\n     * @return {Promise<void>} id\n     */\n    async login(token) {\n      const userId = this.getUserId(token);\n      const socketId = this.ctx.socket.id;\n      await app.redis.set(SOCKET + userId, socketId);\n      return socketId;\n    }\n\n    /**\n     * 聊天消息\n     * @param {String} userToken token\n     * @param {String} targetId 发往id\n     * @param {String} content 消息内容\n     * @param {String} type 消息类型\n     */\n    async chat(userToken, targetId, content, type) {\n      const userId = this.getUserId(userToken);\n      const chatId = targetId < userId ? targetId + userId : userId + targetId;\n      await new Chat({\n        chatId,\n        type,\n        content,\n        sender: userId,\n      }).save();\n      const targetSocketId = await app.redis.get(SOCKET + targetId);\n      if (targetSocketId) {\n        this.ctx.socket.nsp.sockets[targetSocketId].emit('chat', {\n          type,\n          content,\n          sender: userId,\n        });\n      } else {\n        await app.redis.sadd(CHAT + targetId, 'chatId');\n      }\n    }\n\n    /**\n     * 点赞\n     * @param {String} userToken token\n     * @param {String} targetId 被赞的人id\n     * @param {String} circleId 动态id\n     */\n    async like(userToken, targetId, circleId) {\n      const userId = this.getUserId(userToken);\n      const user = await User.findById(userId);\n      await new Message({\n        myId: targetId,\n        type: 'like',\n        userId,\n        nickName: user.nickName,\n        circleId,\n      }).save();\n      const targetSocketId = await app.redis.get(SOCKET + targetId);\n      if (targetSocketId) {\n        this.ctx.socket.nsp.sockets[targetSocketId].emit('message', {\n          type: 'like',\n          userId,\n          nickName: user.nickName,\n          circleId,\n        });\n      } else {\n        await app.redis.set(MESSAGE + targetId, '1');\n      }\n    }\n\n    /**\n     * 评论\n     * @param {String} userToken token\n     * @param {String} circleId 动态id\n     * @param {String} targetId 被评论的人id\n     */\n    async comment(userToken, circleId, targetId) {\n      const userId = this.getUserId(userToken);\n      const user = await User.findById(userId);\n      const circle = await Circle.findById(circleId);\n      const authorId = circle.userId;\n      await new Message({\n        myId: authorId,\n        type: 'comment',\n        userId,\n        nickName: user.nickName,\n        circleId,\n      }).save();\n      const authorSocketId = await app.redis.get(SOCKET + authorId);\n      if (authorSocketId) {\n        this.ctx.socket.nsp.sockets[authorSocketId].emit('message', {\n          type: 'comment',\n          userId,\n          nickName: user.nickName,\n          circleId,\n        });\n      } else {\n        await app.redis.set(MESSAGE + authorId, '1');\n      }\n      if (targetId) {\n        await new Message({\n          myId: targetId,\n          type: 'reply',\n          userId,\n          nickName: user.nickName,\n          circleId,\n        }).save();\n        const targetSocketId = await app.redis.get(SOCKET + targetId);\n        if (targetSocketId) {\n          this.ctx.socket.nsp.sockets[targetSocketId].emit('message', {\n            type: 'reply',\n            userId,\n            nickName: user.nickName,\n            circleId,\n          });\n        } else {\n          await app.redis.set(MESSAGE + targetId, '1');\n        }\n      }\n    }\n\n    /**\n     * 回答\n     * @param {String} userToken token\n     * @param {String} questionId 问题id\n     */\n    async answer(userToken, questionId) {\n      const userId = this.getUserId(userToken);\n      const user = await User.findById(userId);\n      const question = await Question.findById(questionId);\n      const attentions = question.attentions;\n      const authorId = question.userId;\n      await new Message({\n        myId: authorId,\n        type: 'answer',\n        userId,\n        nickName: user.nickName,\n        questionId: question._id,\n        title: question.title,\n      }).save();\n      const authorSocketId = await app.redis.get(SOCKET + authorId);\n      if (authorSocketId) {\n        this.ctx.socket.nsp.sockets[authorSocketId].emit('message', {\n          type: 'answer',\n          userId,\n          nickName: user.nickName,\n          questionId: question._id,\n          title: question.title,\n        });\n      } else {\n        await app.redis.rpush(MESSAGE + authorId, '1');\n      }\n      attentions.forEach(async id => {\n        await new Message({\n          myId: id,\n          type: 'attention',\n          userId,\n          nickName: user.nickName,\n          questionId: question._id,\n          title: question.title,\n        }).save();\n        const socketId = await app.redis.get(SOCKET + id);\n        if (socketId) {\n          this.ctx.socket.nsp.sockets[socketId].emit('message', {\n            type: 'attention',\n            userId,\n            nickName: user.nickName,\n            questionId: question._id,\n            title: question.title,\n          });\n        } else {\n          await app.redis.set(MESSAGE + id, '1');\n        }\n      });\n    }\n\n    /**\n     * 邀请回答\n     * @param {String} userToken token\n     * @param {String} expertId 专家id\n     * @param {String} questionId 问题id\n     */\n    async invite(userToken, expertId, questionId) {\n      const userId = this.getUserId(userToken);\n      const user = await User.findById(userId);\n      const question = await Question.findById(questionId);\n      await new Message({\n        myId: expertId,\n        type: 'invite',\n        userId,\n        nickName: user.nickName,\n        questionId: question._id,\n        title: question.title,\n      }).save();\n      const expertSocketId = await app.redis.get(SOCKET + expertId);\n      if (expertSocketId) {\n        this.ctx.socket.nsp.sockets[expertSocketId].emit('message', {\n          type: 'invite',\n          userId,\n          nickName: user.nickName,\n          questionId: question._id,\n          title: question.title,\n        });\n      } else {\n        await app.redis.set(MESSAGE + expertId, '1');\n      }\n    }\n\n    /**\n     * 关注用户\n     * @param {String} userToken token\n     * @param {String} targetId 被关注的人id\n     */\n    async follow(userToken, targetId) {\n      const userId = this.getUserId(userToken);\n      const user = await User.findById(userId);\n      await new Message({\n        myId: targetId,\n        type: 'follow',\n        userId,\n        nickName: user.nickName,\n      }).save();\n      const targetSocketId = await app.redis.get(SOCKET + targetId);\n      if (targetSocketId) {\n        this.ctx.socket.nsp.sockets[targetSocketId].emit('message', {\n          type: 'follow',\n          userId,\n          nickName: user.nickName,\n        });\n      } else {\n        await app.redis.set(MESSAGE + targetId, '1');\n      }\n    }\n\n    /**\n     * 从token中获取id\n     * @param {String} token token\n     * @return {String} userId 用户id\n     */\n    getUserId(token) {\n      return this.ctx.app.jwt.verify(token, '123456').userId;\n    }\n  }\n\n  return IOService;\n};\n"]}