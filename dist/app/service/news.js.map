{"version":3,"sources":["../../../app/service/news.js"],"names":["cheerio","require","module","exports","baseUrl","User","app","model","UserService","ctx","curl","timeout","dataType","result","$","load","data","navItem","scroll","todayNews","each","index","element","itemName","find","text","navUrl","attr","slice","push","splice","title","trim","imageUrl","articleUrl","articleId","getArticleId","rank","url","content","images","articles","from","time","read","desc","articleInfo","forEach","type","length","page","date","update","_id","user","$push","collections","$inc","collectionCount","Error","$pull","lastIndexOf","Service"],"mappings":"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","file":"news.js","sourcesContent":["'use strict';\nconst cheerio = require('cheerio');\nmodule.exports = app => {\n  const baseUrl = 'http://news.wugu.com.cn/';\n  const {\n    User,\n  } = app.model;\n  class UserService extends app.Service {\n\n    /**\n     * 获取新闻首页\n     * @return {*} 导航栏，轮播图，今日热点\n     */\n    async getArticleIndex() {\n      const result = await this.ctx.curl(baseUrl, {\n        timeout: 3000,\n        dataType: 'text',\n      });\n      const $ = cheerio.load(result.data);\n      const navItem = [];\n      const scroll = [];\n      const todayNews = [];\n      $('.nav_item').each((index, element) => {\n        const itemName = $(element).find('a').text();\n        const navUrl = $(element).find('a').attr('href')\n          .slice(1);\n        navItem.push({\n          itemName,\n          navUrl,\n        });\n      });\n      navItem.splice(8, 1);\n      $('.iscroll_li').each((index, element) => {\n        const title = $(element).find('.banner_title').text()\n          .trim();\n        const imageUrl = $(element).find('img').data('url');\n        const articleUrl = $(element).find('a').attr('href');\n        const articleId = this.getArticleId(articleUrl);\n        scroll.push({\n          title,\n          imageUrl,\n          articleId,\n        });\n      });\n      $('.focus_contain a').each((index, element) => {\n        const title = $(element).attr('title');\n        const articleUrl = $(element).attr('href');\n        const articleId = this.getArticleId(articleUrl);\n        todayNews.push({\n          rank: index + 1,\n          title,\n          articleId,\n        });\n      });\n      return {\n        navItem,\n        scroll,\n        todayNews,\n      };\n    }\n\n    /**\n     * 获取文章内容\n     * @param {string} articleId 新闻id\n     * @return {*} 新闻详情\n     */\n    async getArticleInfo(articleId) {\n      const url = `${baseUrl}article/${articleId}.html`;\n      const result = await this.ctx.curl(url, {\n        timeout: 3000,\n        dataType: 'text',\n      });\n      const $ = cheerio.load(result.data);\n      const content = [];\n      const images = [];\n      const articles = $('.articles');\n      const title = $('.la', articles).text();\n      const from = $('.words_author', articles).text();\n      const time = $('.time', articles).text();\n      const read = $('.reyd', articles).text();\n      const desc = $('.ddcon', articles).text();\n      let imageUrl;\n      $('.wd p', articles).each((index, element) => {\n        imageUrl = $(element).find('img').data('url');\n        if (imageUrl) {\n          images.push(imageUrl);\n        }\n        content.push($(element).text().trim());\n      });\n      const articleInfo = [];\n      let index = 0;\n      content.forEach(element => {\n        if (element !== '') {\n          articleInfo.push({\n            type: 'word',\n            content: element,\n          });\n        } else {\n          if (index < images.length) {\n            articleInfo.push({\n              type: 'image',\n              content: images[index++],\n            });\n          } else {\n            articleInfo.push({\n              type: 'word',\n              content: '',\n            });\n          }\n        }\n      });\n      return {\n        title,\n        from,\n        time,\n        read,\n        desc,\n        articleInfo,\n      };\n    }\n\n    /**\n     * 分页查询新闻列表\n     * @param {string} itemName 列表项导航\n     * @param {string} page 页码\n     * @return {string} 列表信息\n     */\n    async getArticleListByPage(itemName, page) {\n      const url = `${baseUrl}${itemName}_${page}.html`;\n      const result = await this.ctx.curl(url, {\n        timeout: 3000,\n        dataType: 'text',\n      });\n      const $ = cheerio.load(result.data);\n      const articles = [];\n      $('.recommend_item').each((index, element) => {\n        const articleUrl = $(element).find('a').attr('href');\n        const articleId = this.getArticleId(articleUrl);\n        const title = $(element).find('a').text()\n          .trim();\n        const imageUrl = $(element).find('img').data('url');\n        const desc = $(element).find('.recommend_explain').text()\n          .trim();\n        const date = $(element).find('.recommend_date').text();\n        const read = $(element).find('.recommend_read').text();\n        articles.push({\n          articleId,\n          title,\n          imageUrl,\n          desc,\n          date,\n          read,\n        });\n      });\n      return {\n        articles,\n      };\n    }\n\n    /**\n     * 收藏文章\n     * @param {string} articleId 新闻id\n     * @param {string} title 新闻标题\n     * @return {string} 成功状态\n     */\n    async addToCollections(articleId, title) {\n      try {\n        await User.update({\n          _id: this.ctx.user._id,\n        }, {\n          $push: {\n            collections: {\n              articleId,\n              title,\n            },\n          },\n          $inc: {\n            collectionCount: 1,\n          },\n        });\n        return 'success';\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 取消收藏\n     * @param {string} articleId 新闻id\n     * @return {string} 成功状态\n     */\n    async deleteFromCollections(articleId) {\n      try {\n        await User.update({\n          _id: this.ctx.user._id,\n        }, {\n          $pull: {\n            collections: {\n              articleId,\n            },\n          },\n          $inc: {\n            collectionCount: -1,\n          },\n        });\n        return 'success';\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 获取新闻id\n     * @param {string} articleUrl 新闻url\n     * @return {string} 新闻id\n     */\n    getArticleId(articleUrl) {\n      return articleUrl.slice(articleUrl.lastIndexOf('/') + 1, -5);\n    }\n  }\n  return UserService;\n};\n"]}