{"version":3,"sources":["../../../app/service/question.js"],"names":["module","exports","app","model","Question","User","Tag","PAGE_SIZE","QuestionService","title","content","tagName","images","user","ctx","desc","length","slice","findOne","tag","userId","_id","nickName","headImage","location","save","question","findByIdAndUpdate","$inc","questionCount","Error","questionId","remove","res","result","n","findById","count","answerCount","$push","answers","certification","id","answerId","update","$pull","nModified","$set","console","log","last","find","time","$lt","sort","limit","exec","Service"],"mappings":"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","file":"question.js","sourcesContent":["'use strict';\n\nmodule.exports = app => {\n  const {\n    Question,\n    User,\n    Tag,\n  } = app.model;\n  const PAGE_SIZE = 30;\n  class QuestionService extends app.Service {\n\n    /**\n     * 新建问题\n     * @param {String} title 标题\n     * @param {String} content 内容\n     * @param {String} tagName 分类标签名\n     * @param {String} images 图片地址\n     * @return {*} 问题详情数据\n     */\n    async addQuestion(title, content, tagName, images) {\n      const user = this.ctx.user;\n      try {\n        let desc;\n        if (content.length > 30) {\n          desc = content.slice(0, 30);\n        } else {\n          desc = content;\n        }\n        const tag = await Tag.findOne({\n          tagName,\n        });\n        const question = await new Question({\n          title,\n          content,\n          tag,\n          images,\n          desc,\n          userId: user._id,\n          nickName: user.nickName,\n          headImage: user.headImage,\n          location: user.location,\n        }).save();\n        await User.findByIdAndUpdate(user._id, {\n          $inc: {\n            questionCount: 1,\n          },\n        });\n        return {\n          question,\n        };\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 删除问题\n     * @param {String} questionId 问题id\n     * @return {*} 成功状态\n     */\n    async deleteQuestion(questionId) {\n      try {\n        const res = await Question.remove({\n          _id: questionId,\n          userId: this.ctx.user._id,\n        });\n        if (res.result.n !== 1) {\n          throw new Error();\n        }\n        return 'success';\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 添加回答\n     * @param {String} questionId 问题id\n     * @param {String} content 内容\n     * @param {String} images 图片地址\n     * @return {*} 回答\n     */\n    async addAnswer(questionId, content, images) {\n      const user = this.ctx.user;\n      try {\n        const question = await Question.findById(questionId);\n        await Question.findByIdAndUpdate(questionId, {\n          $inc: {\n            count: 1,\n            answerCount: 1,\n          },\n          $push: {\n            answers: {\n              _id: question.count + 1,\n              content,\n              userId: user._id,\n              nickName: user.nickName,\n              headImage: user.headImage,\n              certification: user.certification,\n              images,\n            },\n          },\n        });\n        const result = await Question.findById(questionId, 'answers');\n        return result.answers.id(question.count + 1);\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 删除回答\n     * @param {String} questionId 问题id\n     * @param {Number} answerId 回答id\n     * @return {*} 成功状态\n     */\n    async deleteAnswer(questionId, answerId) {\n      try {\n        const res = await Question.update({\n          _id: questionId,\n        }, {\n          $inc: {\n            answerCount: -1,\n          },\n          $pull: {\n            answers: {\n              _id: answerId,\n            },\n          },\n        });\n        if (res.nModified !== 1) {\n          throw new Error();\n        }\n        return 'success';\n      } catch (e) {\n        throw new Error('DELETE_ERROR');\n      }\n    }\n\n    /**\n     * 采纳答案\n     * @param {String} questionId 问题id\n     * @param {Number} answerId 回答id\n     * @return {*} 成功状态\n     */\n    async acceptAnswer(questionId, answerId) {\n      try {\n        const res = await Question.update({\n          _id: questionId,\n          'answers._id': answerId,\n        }, {\n          $set: {\n            'answers.$._id': 0,\n          },\n        });\n        if (res.nModified !== 1) {\n          throw new Error();\n        }\n        console.log(res);\n        return 'success';\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    async getExpertList() {\n      //\n    }\n\n    /**\n     * 分类获取问题列表\n     * @param {String} tag 标签\n     * @param {String} last 最后时间\n     * @return {*} 问题列表\n     */\n    async getQuestionList(tag, last) {\n      try {\n        const res = await Question.find({\n          'tag.tagId': tag,\n          time: { $lt: last },\n        }, '_id desc title images finishState answerCount tag time').sort({\n          time: 'desc',\n        }).limit(PAGE_SIZE)\n          .exec();\n        return res;\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 获取全部问题列表\n     * @param {String} last 最后时间\n     * @return {*} 问题列表\n     */\n    async getAllQuestionList(last) {\n      try {\n        const res = await Question.find({\n          time: { $lt: last },\n        }, '_id desc title images finishState answerCount tag time').sort({\n          time: 'desc',\n        }).limit(PAGE_SIZE)\n          .exec();\n        return res;\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 获取问题详情\n     * @param {String} id 问题id\n     * @return {*} 问题列表\n     */\n    async getQuestion(id) {\n      try {\n        const res = await Question.findById(id);\n        return res;\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n\n    /**\n     * 获取问题标签\n     * @return {*} 问题标签\n     */\n    async getTags() {\n      try {\n        const res = await Tag.find({});\n        return res;\n      } catch (e) {\n        throw new Error('SOMETHING_ERROR');\n      }\n    }\n  }\n  return QuestionService;\n};\n"]}